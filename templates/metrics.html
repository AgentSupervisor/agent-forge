{% extends "base.html" %}
{% block title %}Metrics - Agent Forge{% endblock %}
{% block nav_metrics %}active{% endblock %}

{% block content %}
<div x-data="metricsPage()" x-init="init()" @metrics-update.window="updateMetrics($event.detail)" id="metrics-page">

    <!-- Header bar -->
    <div class="stats-bar">
        <div class="stat-item">
            <span class="stat-value">System Metrics</span>
        </div>
        <div style="flex:1;"></div>
        <div class="stat-item">
            <span style="font-size:11px;color:var(--text-muted);" id="metrics-last-update">Waiting for data...</span>
        </div>
    </div>

    <!-- Content -->
    <div style="padding: 24px;">

        <!-- Claude Code Usage -->
        <div style="margin-bottom:32px;" x-show="claudeUsage">
            <h2 style="font-size:11px; font-weight:600; text-transform:uppercase; letter-spacing:0.05em; color:var(--text-muted); margin-bottom:16px;">Claude Code Usage</h2>
            <div class="claude-usage-grid">

                <!-- Current Session Card -->
                <div class="claude-usage-card primary">
                    <div class="metric-card-header">
                        <span class="metric-label">Current Session</span>
                    </div>
                    <div class="claude-cost-big" x-text="claudeUsage && claudeUsage.current_block ? formatCost(claudeUsage.current_block.total_cost_usd) : '--'">--</div>
                    <div style="font-size:11px; color:var(--text-muted); margin-bottom:16px;">Current 5h block</div>
                    <div class="metric-details">
                        <div class="metric-detail-row">
                            <span>Input tokens</span>
                            <span x-text="claudeUsage && claudeUsage.current_block ? formatTokens(claudeUsage.current_block.total_input_tokens) : '--'">--</span>
                        </div>
                        <div class="metric-detail-row">
                            <span>Output tokens</span>
                            <span x-text="claudeUsage && claudeUsage.current_block ? formatTokens(claudeUsage.current_block.total_output_tokens) : '--'">--</span>
                        </div>
                        <div class="metric-detail-row">
                            <span>Messages</span>
                            <span x-text="claudeUsage && claudeUsage.current_block ? claudeUsage.current_block.message_count : '--'">--</span>
                        </div>
                    </div>
                    <!-- Visual progress bar (indeterminate) -->
                    <div style="margin-top:16px; height:4px; background:var(--border); border-radius:2px; overflow:hidden;">
                        <div style="height:100%; width:100%; background:linear-gradient(90deg, rgba(99,102,241,0.15) 0%, rgba(99,102,241,0.6) 50%, rgba(99,102,241,0.15) 100%); background-size:200% 100%; animation:shimmer 2s linear infinite; border-radius:2px;"></div>
                    </div>
                </div>

                <!-- Per-Model Breakdown Card -->
                <div class="claude-usage-card">
                    <div class="metric-card-header">
                        <span class="metric-label">Per-Model Breakdown</span>
                    </div>
                    <template x-if="claudeUsage && claudeUsage.current_block && Object.keys(claudeUsage.current_block.models).length > 0">
                        <div>
                            <template x-for="[modelKey, modelData] in Object.entries(claudeUsage.current_block.models)" :key="modelKey">
                                <div class="model-row">
                                    <div class="model-name">
                                        <span class="model-dot" :class="modelClass(modelKey)"></span>
                                        <span x-text="modelDisplayName(modelKey)"></span>
                                    </div>
                                    <div class="model-stats">
                                        <div x-text="formatTokens(modelData.input_tokens + modelData.output_tokens) + ' tokens'"></div>
                                        <div x-text="formatCost(modelData.cost_usd)"></div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </template>
                    <template x-if="!claudeUsage || !claudeUsage.current_block || Object.keys(claudeUsage.current_block.models).length === 0">
                        <div style="color:var(--text-muted); font-size:13px; padding:16px 0;">No model data</div>
                    </template>
                </div>

                <!-- Burn Rate Card -->
                <div class="claude-usage-card">
                    <div class="metric-card-header">
                        <span class="metric-label">Burn Rate</span>
                    </div>
                    <div style="display:flex; flex-direction:column; gap:20px; padding-top:8px;">
                        <div>
                            <div class="burn-rate-value" x-text="claudeUsage && claudeUsage.current_block && claudeUsage.current_block.burn_rate_tokens_per_min != null ? formatTokens(claudeUsage.current_block.burn_rate_tokens_per_min) : '--'">--</div>
                            <div class="burn-rate-label">tokens / min</div>
                        </div>
                        <div>
                            <div class="burn-rate-value" x-text="claudeUsage && claudeUsage.current_block && claudeUsage.current_block.burn_rate_cost_per_hour != null ? formatCost(claudeUsage.current_block.burn_rate_cost_per_hour) : '--'">--</div>
                            <div class="burn-rate-label">cost / hour</div>
                        </div>
                    </div>
                </div>

                <!-- 24h Total Card -->
                <div class="claude-usage-card">
                    <div class="metric-card-header">
                        <span class="metric-label">24h Total</span>
                    </div>
                    <div style="display:flex; flex-direction:column; gap:20px; padding-top:8px;">
                        <div>
                            <div class="burn-rate-value" x-text="claudeUsage ? formatTokens(claudeUsage.total_tokens_24h) : '--'">--</div>
                            <div class="burn-rate-label">total tokens</div>
                        </div>
                        <div>
                            <div class="burn-rate-value" x-text="claudeUsage ? formatCost(claudeUsage.total_cost_24h) : '--'">--</div>
                            <div class="burn-rate-label">total cost</div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- System Overview Cards -->
        <div style="margin-bottom:32px;">
            <h2 style="font-size:11px; font-weight:600; text-transform:uppercase; letter-spacing:0.05em; color:var(--text-muted); margin-bottom:16px;">System Overview</h2>
            <div class="metrics-grid">

                <!-- CPU Card -->
                <div class="metric-card">
                    <div class="metric-card-header">
                        <span class="metric-label">CPU</span>
                        <span class="metric-value" id="metric-cpu-percent">--</span>
                    </div>
                    <div class="metric-gauge-ring">
                        <svg viewBox="0 0 100 100" class="gauge-svg">
                            <circle cx="50" cy="50" r="45" class="gauge-bg"></circle>
                            <circle cx="50" cy="50" r="45" class="gauge-fill" id="gauge-cpu"></circle>
                        </svg>
                        <div class="gauge-center">
                            <span class="gauge-value" id="gauge-cpu-val">0%</span>
                        </div>
                    </div>
                    <div class="metric-details">
                        <div class="metric-detail-row">
                            <span>1m load</span>
                            <span id="metric-cpu-load1">--</span>
                        </div>
                        <div class="metric-detail-row">
                            <span>5m load</span>
                            <span id="metric-cpu-load5">--</span>
                        </div>
                        <div class="metric-detail-row">
                            <span>15m load</span>
                            <span id="metric-cpu-load15">--</span>
                        </div>
                    </div>
                </div>

                <!-- Memory Card -->
                <div class="metric-card">
                    <div class="metric-card-header">
                        <span class="metric-label">Memory</span>
                        <span class="metric-value" id="metric-mem-percent">--</span>
                    </div>
                    <div class="metric-gauge-ring">
                        <svg viewBox="0 0 100 100" class="gauge-svg">
                            <circle cx="50" cy="50" r="45" class="gauge-bg"></circle>
                            <circle cx="50" cy="50" r="45" class="gauge-fill" id="gauge-mem"></circle>
                        </svg>
                        <div class="gauge-center">
                            <span class="gauge-value" id="gauge-mem-val">0%</span>
                        </div>
                    </div>
                    <div class="metric-details">
                        <div class="metric-detail-row">
                            <span>Used</span>
                            <span id="metric-mem-used">--</span>
                        </div>
                        <div class="metric-detail-row">
                            <span>Total</span>
                            <span id="metric-mem-total">--</span>
                        </div>
                        <div class="metric-detail-row">
                            <span>Agents</span>
                            <span id="metric-mem-agents">--</span>
                        </div>
                    </div>
                </div>

                <!-- Disk Card -->
                <div class="metric-card">
                    <div class="metric-card-header">
                        <span class="metric-label">Disk</span>
                        <span class="metric-value" id="metric-disk-percent">--</span>
                    </div>
                    <div class="metric-gauge-ring">
                        <svg viewBox="0 0 100 100" class="gauge-svg">
                            <circle cx="50" cy="50" r="45" class="gauge-bg"></circle>
                            <circle cx="50" cy="50" r="45" class="gauge-fill" id="gauge-disk"></circle>
                        </svg>
                        <div class="gauge-center">
                            <span class="gauge-value" id="gauge-disk-val">0%</span>
                        </div>
                    </div>
                    <div class="metric-details">
                        <div class="metric-detail-row">
                            <span>Used</span>
                            <span id="metric-disk-used">--</span>
                        </div>
                        <div class="metric-detail-row">
                            <span>Total</span>
                            <span id="metric-disk-total">--</span>
                        </div>
                    </div>
                </div>

                <!-- Network Card -->
                <div class="metric-card">
                    <div class="metric-card-header">
                        <span class="metric-label">Network</span>
                    </div>
                    <div class="metric-network-display">
                        <div class="network-stat">
                            <span class="network-icon">↑</span>
                            <div>
                                <div class="network-label">Upload</div>
                                <div class="network-value" id="metric-net-up">-- MB/s</div>
                            </div>
                        </div>
                        <div class="network-stat">
                            <span class="network-icon">↓</span>
                            <div>
                                <div class="network-label">Download</div>
                                <div class="network-value" id="metric-net-down">-- MB/s</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- GPU Card (conditionally shown) -->
                <div class="metric-card" id="metric-gpu-card" style="display:none;">
                    <div class="metric-card-header">
                        <span class="metric-label">GPU</span>
                        <span class="metric-value" id="metric-gpu-percent">--</span>
                    </div>
                    <div class="metric-gauge-ring">
                        <svg viewBox="0 0 100 100" class="gauge-svg">
                            <circle cx="50" cy="50" r="45" class="gauge-bg"></circle>
                            <circle cx="50" cy="50" r="45" class="gauge-fill" id="gauge-gpu"></circle>
                        </svg>
                        <div class="gauge-center">
                            <span class="gauge-value" id="gauge-gpu-val">0%</span>
                        </div>
                    </div>
                    <div class="metric-details">
                        <div class="metric-detail-row">
                            <span>Name</span>
                            <span id="metric-gpu-name" style="font-size:10px;">--</span>
                        </div>
                        <div class="metric-detail-row">
                            <span>Memory</span>
                            <span id="metric-gpu-mem">--</span>
                        </div>
                        <div class="metric-detail-row">
                            <span>Temp</span>
                            <span id="metric-gpu-temp">--</span>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- History Charts -->
        <div style="margin-bottom:32px;">
            <h2 style="font-size:11px; font-weight:600; text-transform:uppercase; letter-spacing:0.05em; color:var(--text-muted); margin-bottom:16px;">History (last 5 minutes)</h2>
            <div class="chart-grid">
                <div class="chart-card">
                    <h3 class="chart-title">CPU Usage</h3>
                    <canvas id="chart-cpu"></canvas>
                </div>
                <div class="chart-card">
                    <h3 class="chart-title">Memory Usage</h3>
                    <canvas id="chart-mem"></canvas>
                </div>
            </div>
        </div>

        <!-- Per-Agent Resources -->
        <div style="margin-bottom:32px;">
            <h2 style="font-size:11px; font-weight:600; text-transform:uppercase; letter-spacing:0.05em; color:var(--text-muted); margin-bottom:16px;">Agent Resources</h2>
            <div class="agent-metrics-table">
                <table>
                    <thead>
                        <tr>
                            <th>Agent ID</th>
                            <th>Project</th>
                            <th>Status</th>
                            <th>CPU %</th>
                            <th>Memory</th>
                            <th>Processes</th>
                        </tr>
                    </thead>
                    <tbody id="agent-metrics-tbody">
                        <tr>
                            <td colspan="6" style="text-align:center;color:var(--text-muted);padding:32px;">Waiting for metrics data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
<script>
function metricsPage() {
    // Keep Chart.js instances and history arrays outside Alpine's reactive proxy.
    // Alpine v3 wraps returned properties in a Proxy which breaks Chart.js internals.
    var _cpuChart = null;
    var _memChart = null;
    var _cpuHistory = [];
    var _memHistory = [];
    var _maxDataPoints = 60;

    function _initCharts() {
        var chartConfig = {
            type: 'line',
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: false,
                plugins: {
                    legend: { display: false },
                },
                scales: {
                    x: { display: false },
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            color: 'rgba(139, 149, 165, 0.8)',
                            callback: function (v) { return v + '%'; },
                        },
                        grid: { color: 'rgba(40, 45, 56, 0.5)' },
                    },
                },
            },
        };

        _cpuChart = new Chart(document.getElementById('chart-cpu'), {
            type: chartConfig.type,
            options: chartConfig.options,
            data: {
                labels: [],
                datasets: [{
                    data: [],
                    borderColor: 'rgb(99, 102, 241)',
                    backgroundColor: 'rgba(99, 102, 241, 0.1)',
                    borderWidth: 2,
                    tension: 0.3,
                    fill: true,
                }],
            },
        });

        _memChart = new Chart(document.getElementById('chart-mem'), {
            type: chartConfig.type,
            options: chartConfig.options,
            data: {
                labels: [],
                datasets: [{
                    data: [],
                    borderColor: 'rgb(16, 185, 129)',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    borderWidth: 2,
                    tension: 0.3,
                    fill: true,
                }],
            },
        });
    }

    function _addDataPoint(type, value) {
        var history = type === 'cpu' ? _cpuHistory : _memHistory;
        var chart = type === 'cpu' ? _cpuChart : _memChart;
        if (!chart) return;

        history.push(value);
        if (history.length > _maxDataPoints) {
            history.shift();
        }

        chart.data.labels = history.map(function (_, i) { return i; });
        chart.data.datasets[0].data = history.slice();
        chart.update('none');
    }

    function _updateGauge(id, percent) {
        var gauge = document.getElementById(id);
        if (!gauge) return;
        // Set stroke-dashoffset directly — CSS calc() with var() is unreliable on SVG
        var offset = 283 - (283 * percent / 100);
        gauge.style.strokeDashoffset = offset;
        gauge.classList.remove('gauge-low', 'gauge-medium', 'gauge-high');
        if (percent >= 80) {
            gauge.classList.add('gauge-high');
        } else if (percent >= 50) {
            gauge.classList.add('gauge-medium');
        } else {
            gauge.classList.add('gauge-low');
        }
    }

    return {
        claudeUsage: null,

        init() {
            _initCharts();
            // Load initial snapshot from REST API
            fetch('/api/metrics')
                .then(function (res) { return res.ok ? res.json() : null; })
                .then(function (data) {
                    if (data) _updatePage({ system: data.system, agents: data.agents });
                })
                .catch(function (e) { console.error('Failed to load initial metrics:', e); });
            // Load Claude usage data
            this.loadClaudeUsage();
            var self = this;
            setInterval(function () { self.loadClaudeUsage(); }, 60000);
        },

        updateMetrics(data) {
            _updatePage(data);
            if (data.claude_usage) {
                this.claudeUsage = data.claude_usage;
            }
        },

        loadClaudeUsage() {
            var self = this;
            fetch('/api/claude-usage')
                .then(function (res) { return res.ok ? res.json() : null; })
                .then(function (data) { self.claudeUsage = data; })
                .catch(function (e) { console.error('Failed to load Claude usage:', e); });
        },

        formatTokens(n) {
            if (n == null) return '--';
            if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
            if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
            return String(Math.round(n));
        },

        formatCost(n) {
            if (n == null) return '--';
            return '$' + Number(n).toFixed(2);
        },

        modelDisplayName(key) {
            // Strip "claude-" prefix and version suffix, capitalise first letter
            var name = key.replace(/^claude-/i, '').split('-')[0];
            return name.charAt(0).toUpperCase() + name.slice(1);
        },

        modelClass(key) {
            var lower = key.toLowerCase();
            if (lower.includes('opus')) return 'opus';
            if (lower.includes('sonnet')) return 'sonnet';
            if (lower.includes('haiku')) return 'haiku';
            return '';
        },
    };

    function _updatePage(data) {
        var sys = data.system || {};
        var agents = data.agents || {};

        // Timestamp
        document.getElementById('metrics-last-update').textContent =
            'Last update: ' + new Date().toLocaleTimeString();

        // --- CPU ---
        if (sys.cpu_percent != null) {
            document.getElementById('metric-cpu-percent').textContent = sys.cpu_percent.toFixed(1) + '%';
            document.getElementById('gauge-cpu-val').textContent = sys.cpu_percent.toFixed(0) + '%';
            _updateGauge('gauge-cpu', sys.cpu_percent);
            _addDataPoint('cpu', sys.cpu_percent);
        }
        if (sys.load_avg_1min != null) {
            document.getElementById('metric-cpu-load1').textContent = sys.load_avg_1min.toFixed(2);
        }
        if (sys.load_avg_5min != null) {
            document.getElementById('metric-cpu-load5').textContent = sys.load_avg_5min.toFixed(2);
        }
        if (sys.load_avg_15min != null) {
            document.getElementById('metric-cpu-load15').textContent = sys.load_avg_15min.toFixed(2);
        }

        // --- Memory ---
        if (sys.memory_percent != null) {
            document.getElementById('metric-mem-percent').textContent = sys.memory_percent.toFixed(1) + '%';
            document.getElementById('gauge-mem-val').textContent = sys.memory_percent.toFixed(0) + '%';
            _updateGauge('gauge-mem', sys.memory_percent);
            _addDataPoint('mem', sys.memory_percent);
        }
        if (sys.memory_used_mb != null && sys.memory_total_mb != null) {
            document.getElementById('metric-mem-used').textContent = (sys.memory_used_mb / 1024).toFixed(1) + ' GB';
            document.getElementById('metric-mem-total').textContent = (sys.memory_total_mb / 1024).toFixed(1) + ' GB';
        }
        if (data.total_agent_memory_mb != null) {
            var agentMem = data.total_agent_memory_mb;
            var label = agentMem >= 1024 ? (agentMem / 1024).toFixed(1) + ' GB' : agentMem.toFixed(0) + ' MB';
            document.getElementById('metric-mem-agents').textContent = label;
        }

        // --- Disk ---
        if (sys.disk_percent != null) {
            document.getElementById('metric-disk-percent').textContent = sys.disk_percent.toFixed(1) + '%';
            document.getElementById('gauge-disk-val').textContent = sys.disk_percent.toFixed(0) + '%';
            _updateGauge('gauge-disk', sys.disk_percent);
        }
        if (sys.disk_used_gb != null && sys.disk_total_gb != null) {
            document.getElementById('metric-disk-used').textContent = sys.disk_used_gb.toFixed(1) + ' GB';
            document.getElementById('metric-disk-total').textContent = sys.disk_total_gb.toFixed(1) + ' GB';
        }

        // --- Network ---
        if (sys.network_sent_mbps != null && sys.network_recv_mbps != null) {
            document.getElementById('metric-net-up').textContent = sys.network_sent_mbps.toFixed(2) + ' MB/s';
            document.getElementById('metric-net-down').textContent = sys.network_recv_mbps.toFixed(2) + ' MB/s';
        }

        // --- GPU (show/hide) ---
        var gpuCard = document.getElementById('metric-gpu-card');
        if (sys.gpu_utilization != null) {
            gpuCard.style.display = 'block';
            document.getElementById('metric-gpu-percent').textContent = sys.gpu_utilization.toFixed(1) + '%';
            document.getElementById('gauge-gpu-val').textContent = sys.gpu_utilization.toFixed(0) + '%';
            _updateGauge('gauge-gpu', sys.gpu_utilization);
            if (sys.gpu_name) {
                document.getElementById('metric-gpu-name').textContent = sys.gpu_name;
            }
            if (sys.gpu_memory_used_mb != null && sys.gpu_memory_total_mb != null) {
                document.getElementById('metric-gpu-mem').textContent =
                    (sys.gpu_memory_used_mb / sys.gpu_memory_total_mb * 100).toFixed(1) + '%';
            }
            if (sys.gpu_temperature != null) {
                document.getElementById('metric-gpu-temp').textContent = sys.gpu_temperature.toFixed(0) + '\u00B0C';
            }
        } else {
            gpuCard.style.display = 'none';
        }

        // --- Per-Agent Metrics Table ---
        _updateAgentTable(agents);
    }

    function _updateAgentTable(agentsData) {
        var tbody = document.getElementById('agent-metrics-tbody');
        if (!agentsData || Object.keys(agentsData).length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--text-muted);padding:32px;">No agent metrics available</td></tr>';
            return;
        }

        fetch('/api/agents')
            .then(function (res) { return res.json(); })
            .then(function (agents) {
                var rows = [];
                for (var aid in agentsData) {
                    var metrics = agentsData[aid];
                    var agent = agents.find(function (a) { return a.id === aid; });
                    if (!agent) continue;

                    var statusClass = agent.status;
                    var statusLabel = agent.status.replace('_', ' ');
                    var cpuPct = metrics.cpu_percent != null ? metrics.cpu_percent.toFixed(1) + '%' : '--';
                    var memMb = metrics.memory_mb != null ? metrics.memory_mb.toFixed(0) + ' MB' : '--';
                    var procCount = metrics.process_count || '--';

                    rows.push(
                        '<tr onclick="window.location=\'/agent/' + aid + '\'" style="cursor:pointer;">' +
                        '<td><span style="font-family:monospace;font-size:13px;">' + aid + '</span></td>' +
                        '<td>' + agent.project_name + '</td>' +
                        '<td><span class="status-badge ' + statusClass + '">' + statusLabel + '</span></td>' +
                        '<td style="font-variant-numeric:tabular-nums;">' + cpuPct + '</td>' +
                        '<td style="font-variant-numeric:tabular-nums;">' + memMb + '</td>' +
                        '<td style="font-variant-numeric:tabular-nums;">' + procCount + '</td>' +
                        '</tr>'
                    );
                }
                tbody.innerHTML = rows.join('');
            })
            .catch(function (err) {
                console.error('Failed to fetch agents:', err);
            });
    }
}
</script>
{% endblock %}
